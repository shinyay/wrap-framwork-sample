# AGENTS.md - Copilot Coding Agent 作業ルール

このドキュメントは Copilot coding agent が本リポジトリで自律的に作業する際の**必須ルール**を定義します。

## 目的

- 本リポジトリは **WRAP (Write/Refine/Atomic/Pair) 実験用** の Node.js + TypeScript API スケルトンです
- **1 Issue = 1 PR** の原則で、Issue 駆動開発を行います
- エージェントは Issue の要件を正確に満たす**最小限の変更**のみを行います

## 必須コマンド

以下のコマンドは必ず動作する状態を保ちます。変更後は必ず実行して動作を確認してください。

```bash
# 依存関係のインストール（CI でも使用）
npm ci

# コードのリント
npm run lint

# テストの実行
npm test

# ビルド（TypeScript コンパイル）
npm run build

# 開発サーバーの起動
npm run dev

# ポート番号を指定して起動（bash の例）
PORT=8080 npm run dev
```

### ポート設定

- デフォルトポート: `3000`
- 環境変数 `PORT` で変更可能
- 不正な値の場合は自動的にデフォルト値にフォールバック

## Atomic（原子性）のルール

### 1 PR の粒度

- **1 つの Issue に対して 1 つの PR** を作成します
- PR は**単一の目的**を持ち、その目的以外の変更を含めてはいけません
- 複数の Issue にまたがる変更は避け、必要なら Issue を分割します

### ついで変更の禁止

以下のような「ついで変更」は**厳禁**です：

- ❌ リファクタリングと機能追加を同じ PR に混ぜる
- ❌ Issue に書かれていない「気づいた改善」を含める
- ❌ 無関係なテストやドキュメントの修正を含める
- ❌ フォーマットやリント修正を本来の変更と混ぜる

**原則**: Issue に明記されていない変更は別 Issue として提案してください。

### 変更の最小化

- 目的を達成するための**最小限のコード変更**を行います
- 既存の動作を壊さないことを最優先とします
- 無関係なバグやテスト失敗は修正しません（別 Issue として報告）

## 依存関係追加のルール

### 最小限の原則

- 依存関係の追加は**絶対に必要な場合のみ**行います
- 既存のライブラリで実現できる場合は追加しません
- 重量級のフレームワークは避け、軽量なソリューションを優先します

### 追加時の必須手順

1. **npm audit による脆弱性チェック**を実行
2. **PR description に追加理由を明記**
3. **package-lock.json の差分も含める**（必ずコミット）
4. セキュリティアラートが出た場合は代替案を検討

### 禁止事項

- ❌ 不要なフロントエンドフレームワーク（これはバックエンド API です）
- ❌ データベース ORM（機能要件で明示的に必要な場合を除く）
- ❌ 認証ライブラリ（認証機能が Issue で要求されるまで）
- ❌ 理由を説明しない依存追加

## ファイル配置ガイド

### 現在のディレクトリ構成

```
.
├── src/              # アプリケーションソースコード
│   ├── app.ts        # Express アプリケーション設定
│   └── index.ts      # サーバーエントリーポイント
├── test/             # テストファイル
│   └── *.test.ts     # Jest テストファイル
├── dist/             # ビルド出力（コミット禁止）
├── node_modules/     # 依存関係（コミット禁止）
└── .github/
    └── copilot-instructions.md  # 開発ガイドライン
```

### 配置ルール

- **src/**: すべてのアプリケーションコードはここに配置
  - ビジネスロジックとサーバー起動処理を分離
  - すべて TypeScript で記述
  
- **test/**: すべてのテストコードはここに配置
  - ファイル名は `*.test.ts` パターンに従う
  - API エンドポイントのテストには supertest を使用

- **dist/**: ビルド出力ディレクトリ（.gitignore で除外済み）

### 既存ファイルの役割

- `src/app.ts`: Express アプリケーションの設定とルーティング
- `src/index.ts`: サーバー起動とポート設定、グレースフルシャットダウン
- `/healthz`: ヘルスチェックエンドポイント（戻り値: `{"status":"ok"}`）

## PR への記載テンプレート

すべての PR には以下の情報を含めてください：

### Summary（概要）

- **何を変更したか**を簡潔に記述
- Issue 番号を明記（例: `Fixes #123`）
- 変更の背景と理由を説明

### How to test（テスト方法）

```bash
# 依存関係のインストール
npm ci

# リントチェック
npm run lint

# テストの実行
npm test

# ビルド確認
npm run build

# （機能追加の場合）動作確認
npm run dev
# curl http://localhost:3000/your-new-endpoint
```

### Risks（リスク）

- 破壊的変更の有無
- 既存機能への影響
- 互換性の問題
- パフォーマンスへの影響

### Dependencies（依存関係）

- 新規追加した依存関係と理由
- アップデートした依存関係とバージョン
- セキュリティ脆弱性の対応

## 禁止事項

以下の行為は**絶対に禁止**です：

### セキュリティ

- ❌ シークレット、認証情報、API キーのコミット
- ❌ 個人情報（PII）の含まれるデータのコミット
- ❌ 新たなセキュリティ脆弱性の導入

### ファイル管理

- ❌ `dist/` ディレクトリのコミット（ビルド成果物）
- ❌ `node_modules/` のコミット（依存関係）
- ❌ IDE 固有の設定ファイル（`.idea/`, `.vscode/` など、既存のものを除く）
- ❌ 一時ファイルやログファイルのコミット

### コード変更

- ❌ Issue に書かれていない変更
- ❌ 既存の動作を壊す変更（Issue で明示的に要求されていない限り）
- ❌ 動作中のコードの削除や大幅な書き換え（必要性が明確でない限り）
- ❌ 既存の動作するテストの削除や無効化

### ドキュメント・設定

- ❌ `.github/copilot-instructions.md` の変更（Issue で明示されない限り）
- ❌ `LICENSE` の変更
- ❌ 設定ファイルの「ついで変更」（tsconfig.json, jest.config.js, .eslintrc.js など）

### プロセス

- ❌ 複数の Issue を 1 つの PR にまとめる
- ❌ リファクタリングと機能追加を同じ PR に含める
- ❌ CI/CD 設定の変更（Issue で明示されていない限り）

## 検証プロセス

コード変更後は必ず以下を実行してください：

```bash
npm ci
npm run lint
npm test
npm run build
```

すべてのコマンドが成功することを確認してから PR を作成します。

### エラー対応

- Issue の scope 内のエラー: 修正する
- Issue の scope 外のエラー: PR に記載し、別 Issue として報告
- 環境依存のエラー: PR に記載し、再現手順を明記

## 競合解決

- マージ競合は**エージェントでは解決できません**
- 競合が発生した場合はユーザーに報告してください
- `git rebase` や `git reset --hard` は使用できません（force push 不可）

## 参考ドキュメント

- `.github/copilot-instructions.md`: 開発ガイドラインと規約
- `README.md`: プロジェクト概要とクイックスタート
- `package.json`: 利用可能なスクリプトと依存関係

---

**重要**: このドキュメントのルールは厳守してください。不明な点や矛盾がある場合は、作業を進める前にユーザーに確認してください。
